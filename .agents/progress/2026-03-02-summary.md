# Progress: 2 Mar 2026 — Session Summary

**Plan**: `.agents/plans/security-audit-fixes.md` (Session 3) / No formal plan (Sessions 1-2)
**Date**: 2026-03-02
**Status**: Complete

## Session 1: Production Validation + Maintenance

- [x] Fixed Coolify deployment failure — Nixpacks detected `Gemfile` (Fastlane) as Ruby project
  - Added `nixpacks.toml` with `providers = ["node"]` to force Node.js-only build
  - Commit `2dfd20e` pushed to `main`, Coolify auto-deployed successfully
- [x] Ran full E2E suite against production — **144/144 passing** (Chromium + iPhone 14 + Pixel 7, 11.8 min)
- [x] Cleaned up 78 cancelled test records from production DB (48 leaves + 30 expenses)
  - All were E2E test leftovers from the 6 parallel test runs (3 viewports x 2 passes)
  - Created `scripts/cleanup-cancelled.ts` utility (dry-run support, balance recalculation)

## Session 2: Security Audit + QA Pass

- [x] Ran `npm audit` — **19 vulnerabilities** (2 critical, 7 high, 10 moderate)
- [x] Ran full QA pass — `tsc`, ESLint, Vitest (31/31), `next build`
- [x] Performed OWASP Top 10 code review + audited all 28 API routes
- [x] Compiled full report to `.agents/reports/2026-03-02-security-qa-audit.md`
- **35 findings**: 3 HIGH, 12 MEDIUM, 10 LOW, 10 INFO (positive)

## Session 3: Security Hardening — 15 Fixes Implemented

**Plan**: `.agents/plans/security-audit-fixes.md`
**Commit**: `d588ec4` on `main` (1 ahead of origin, not yet pushed)

### HIGH (3/3 fixed)
- [x] **H-1**: File upload validates magic bytes via `file-type` package, not just client MIME
- [x] **H-2**: Calendar DELETE/PATCH enforces `createdById` ownership check
- [x] **H-3**: Settings GET endpoint now requires authentication

### MEDIUM (7/12 fixed, 1 skipped by user, 4 blocked)
- [x] **M-1**: Security headers added to `next.config.mjs` (X-Frame-Options, nosniff, Referrer-Policy, Permissions-Policy)
- [x] **M-2**: Default employee password is `randomUUID().slice(0,12)` when env var unset
- [x] **M-4**: Cron route always requires `CRON_SECRET` (any environment)
- [x] **M-5**: Chat API validates messages via Zod (max 50 messages, max 4000 chars, no `system` role)
- [x] **M-8**: Mobile Google Auth accepts iOS/Android client ID audiences (`GOOGLE_IOS_CLIENT_ID`, `GOOGLE_ANDROID_CLIENT_ID`)
- [~] **M-6**: Self-approval block — **skipped by user** (bosses are the only admins, fix when HR/managers hired)
- [ ] **M-3**: Rate limiting — deferred (needs `@upstash/ratelimit` + Redis)
- [ ] **M-9/M-10**: File upload persistence — blocked on UploadThing API key
- [ ] **M-11**: Google OAuth domain restriction — blocked on boss decision

### LOW (5/10 fixed)
- [x] **L-1**: Removed Prisma error message leaks from 500 responses (employees/route, employees/[id]/route, settings/company/route)
- [x] **L-2**: Replaced `any` with `Prisma.EmployeeUpdateInput` in employee update route
- [x] **L-4**: Role enum validated against known values in middleware (no more raw `as string` cast)
- [x] **L-9**: Rollover returns 403 (not 401) for authenticated non-admin users
- [x] **L-10**: Removed dead `/admin` route protection from middleware (no `/admin` page exists)

### BUILD
- [x] Excluded `scripts/` from `tsconfig.json` — unblocks `tsc --noEmit` and `next build`

### Code Review Fixes (from code-reviewer agent)
- [x] Tightened calendar ownership guard: `!isDevAuthSkipped()` instead of `currentUserId &&` (prevents silent bypass if userId null)
- [x] Removed `system` from allowed chat roles (prevents client-injected system prompts)

### Validation
- `tsc --noEmit` — 0 errors
- `eslint src/` — 0 errors, 1 pre-existing warning
- `vitest run` — 31/31 passing
- `next build` — succeeds
- E2E (production) — **144/144 passing** (3 viewports, 11.9 min)

### Test-All Report
- Full test sweep documented in `.agents/reports/2026-03-02-test-all-report.md`
- **175 total test runs** (31 unit + 144 E2E), all passing
- Coverage gap analysis: CPF calculator and payroll generation are the top untested critical files

## Session 4: Unit Test Expansion — 31 → 100 tests

**Plan**: `.agents/plans/unit-test-expansion.md`

- [x] **CPF Calculator** (`cpf-calculator.test.ts`) — 35 tests: 5 age tiers (boundaries + midpoints), calculateAge (6 tests incl. leap year), calculateCPF (13 tests: OW ceiling, AW ceiling, rounding, all tiers), calculatePayroll (6 tests: tax rates, deductions, age tiers)
- [x] **Utils** (`utils.test.ts`) — 29 tests: calculateDaysBetween (4 tests), formatCurrency (4 tests), getInitials (3 tests), roundToHalf (4 tests), prorateLeave (14 deterministic tests with fake timers across Mar/Dec/Jan pinned dates)
- [x] **Payroll Generation API** (`payroll-generate.test.ts`) — 13 tests: auth (4: 401/403/ADMIN/HR/MANAGER), validation (3: missing month/year/no employees), generation (5: create/skip-duplicate/skip-no-DOB/mixed/error-handling)
- [x] **Cleanup**: Removed 8 time-dependent proration tests from `leave-api.test.ts` (superseded by deterministic versions in `utils.test.ts`)
- [x] **Code review fixes**: Added MANAGER role test (M-1), added negative sign assertion in formatCurrency (L-2)

### Validation
- `tsc --noEmit` — 0 errors
- `eslint src/__tests__/` — 0 errors
- `vitest run` — **100/100 passing** (35 + 29 + 13 + 23)
- Total test count: **244** (100 unit + 144 E2E)

## Findings

- **`file-type` is ESM-only**: Requires dynamic `import()` in the upload route handler. Works correctly in Next.js App Router.
- **Calendar comments contradicted design**: Old comments said "shared company calendar" but the system design is fully personal. Fixed comments alongside adding ownership checks.
- **`Prisma.EmployeeUpdateInput` works with `Object.assign`**: Despite the type being complex (relation fields), the Zod-validated data spreads cleanly — `tsc` confirms.
- **`scripts/` exclusion from tsconfig is the right pattern**: Utility scripts use `tsx` which has its own TS resolution. They shouldn't block `next build`.
- **Unit test coverage was ~2%**: Only 1 of 86 source files had dedicated unit tests. CPF calculator (financial calculations) had zero tests — highest-risk gap. Now 4 source files have dedicated tests (cpf-calculator, utils, payroll/generate, leave API).

## Remaining

### Actionable (code fixes)
- [ ] Run `npm audit fix` for non-breaking dependency patches
- [ ] Update `next` to 14.2.35+ (test for regressions — 11 CVEs in current version)
- [ ] Update `next-auth` to beta.30+ (email misdelivery CVE)
- [ ] Replace `xlsx` with `exceljs` (prototype pollution, no fix available)
- [ ] Add rate limiting to login endpoint (M-3, needs `@upstash/ratelimit`)
- [x] ~~Write CPF calculator unit tests~~ — Done (35 tests in session 4)
- [x] ~~Write payroll generation API tests~~ — Done (13 tests in session 4)

### Blocked on Boss
- [ ] UploadThing token (file upload persistence)
- [ ] Apple Developer credentials + ASC API key (iOS CI/CD GitHub Secrets)
- [ ] Google OAuth Client IDs for Android/iOS (SHA-1 and Bundle ID)
- [ ] Resend API key (email notifications)
- [ ] Chat widget API key
- [ ] Decision on Google OAuth domain restriction (any Google account can currently create a user)

### Low Priority
- [ ] Fix `isAdmin` inconsistency across files
- [ ] Clean up stale branches (`dev`, `feat/mobile-google-auth`)
- [ ] Block self-approval when HR/managers are hired (M-6)
- [ ] Add `email_verified` check to google-mobile route (reviewer finding)
- [ ] Filter `approvalEmails` from settings GET for non-admin users (reviewer finding)

## Blockers (if any)

- File uploads not persisting in production — needs UploadThing token or Coolify volume mount
- iOS CI/CD workflow untestable without Apple Developer credentials
- 19 dependency vulnerabilities (2 critical) — `npm audit fix` pending

## Next Session Should

1. **Push** security + test commits to deploy to Coolify
2. Run `npm audit fix` for non-breaking dependency patches
3. Consider `next` and `next-auth` version bumps (test carefully)
4. If boss provides API keys → configure UploadThing / Resend / Chat

## Files Changed (This Session)

### Session 1 (committed as `2dfd20e`)
- `nixpacks.toml` — New, forces Nixpacks Node.js provider

### Session 2 (untracked)
- `scripts/cleanup-cancelled.ts` — New utility script
- `.agents/reports/2026-03-02-security-qa-audit.md` — Full audit report

### Session 3 (committed as `d588ec4`)
- `src/app/api/upload/route.ts` — Magic byte validation via `file-type`
- `src/app/api/calendar/[id]/route.ts` — Ownership check on DELETE/PATCH
- `src/app/api/settings/company/route.ts` — Auth on GET, removed error leaks
- `src/app/api/employees/route.ts` — Random default password, removed error leak
- `src/app/api/employees/[id]/route.ts` — `Prisma.EmployeeUpdateInput`, removed error leak
- `next.config.mjs` — Security headers
- `src/app/api/cron/payroll/route.ts` — Always require CRON_SECRET
- `src/app/api/chat/route.ts` — Zod validation (messages array)
- `src/app/api/auth/google-mobile/route.ts` — Multiple OAuth audiences
- `src/middleware.ts` — Role enum validation, dead code removal
- `src/app/api/leave/rollover/route.ts` — 403 not 401 for non-admin
- `tsconfig.json` — Exclude scripts/
- `package.json` + `package-lock.json` — Added `file-type` dependency

### Session 4 (uncommitted — unit test expansion)
- `src/__tests__/cpf-calculator.test.ts` — New (35 tests)
- `src/__tests__/utils.test.ts` — New (29 tests)
- `src/__tests__/payroll-generate.test.ts` — New (13 tests)
- `src/__tests__/leave-api.test.ts` — Modified (removed 8 duplicate proration tests)
- `.agents/plans/unit-test-expansion.md` — Plan file

### Reports (untracked)
- `.agents/reports/2026-03-02-test-all-report.md` — Full test sweep report
- `.agents/plans/security-audit-fixes.md` — Security fix plan
