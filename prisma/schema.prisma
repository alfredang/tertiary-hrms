generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model AuditLog {
  id        String   @id
  userId    String?
  action    String
  entity    String
  entityId  String
  oldValue  Json?
  newValue  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
}

model CalendarEvent {
  id             String    @id
  title          String
  description    String?
  startDate      DateTime
  endDate        DateTime
  allDay         Boolean   @default(false)
  type           EventType
  color          String?
  leaveRequestId String?   @unique
  recurring      Boolean   @default(false)
  recurrenceRule String?
  createdById    String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
}

model Department {
  id          String     @id
  name        String     @unique
  code        String     @unique
  description String?
  headId      String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime
  employees   Employee[]
}

model Employee {
  id                                             String         @id
  userId                                         String         @unique
  employeeId                                     String         @unique
  firstName                                      String
  lastName                                       String
  email                                          String         @unique
  phone                                          String?
  dateOfBirth                                    DateTime
  gender                                         Gender
  nationality                                    String         @default("Singaporean")
  nric                                           String?        @unique
  address                                        String?
  educationLevel                                 EducationLevel @default(DIPLOMA)
  departmentId                                   String
  position                                       String
  employmentType                                 EmploymentType @default(FULL_TIME)
  startDate                                      DateTime
  endDate                                        DateTime?
  status                                         EmployeeStatus @default(ACTIVE)
  managerId                                      String?
  avatarUrl                                      String?
  createdAt                                      DateTime       @default(now())
  updatedAt                                      DateTime
  department         Department     @relation(fields: [departmentId], references: [id])
  manager            Employee?      @relation("EmployeeToEmployee", fields: [managerId], references: [id])
  subordinates       Employee[]     @relation("EmployeeToEmployee")
  user               User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedExpenses   ExpenseClaim[] @relation("ExpenseClaim_approverIdToEmployee")
  expenseClaims      ExpenseClaim[] @relation("ExpenseClaim_employeeIdToEmployee")
  leaveBalances      LeaveBalance[]
  approvedLeaves     LeaveRequest[] @relation("LeaveRequest_approverIdToEmployee")
  leaveRequests      LeaveRequest[] @relation("LeaveRequest_employeeIdToEmployee")
  payslips           Payslip[]
  salaryInfo         SalaryInfo?
}

model ExpenseCategory {
  id              String         @id
  name            String         @unique
  code            String         @unique
  description     String?
  maxAmount       Decimal?       @db.Decimal(12, 2)
  requiresReceipt Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime
  expenseClaims   ExpenseClaim[]
}

model ExpenseClaim {
  id              String          @id
  employeeId      String
  categoryId      String
  description     String
  amount          Decimal         @db.Decimal(12, 2)
  currency        String          @default("SGD")
  expenseDate     DateTime
  receiptUrl      String?
  receiptFileName String?
  status          ExpenseStatus   @default(PENDING)
  approverId      String?
  approvedAt      DateTime?
  rejectedAt      DateTime?
  rejectionReason String?
  paidAt          DateTime?
  paymentReference String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime
  approver        Employee?       @relation("ExpenseClaim_approverIdToEmployee", fields: [approverId], references: [id])
  category        ExpenseCategory @relation(fields: [categoryId], references: [id])
  employee        Employee        @relation("ExpenseClaim_employeeIdToEmployee", fields: [employeeId], references: [id])
}

model LeaveBalance {
  id          String    @id
  employeeId  String
  leaveTypeId String
  year        Int
  entitlement Decimal   @db.Decimal(5, 2)
  used        Decimal   @default(0) @db.Decimal(5, 2)
  pending     Decimal   @default(0) @db.Decimal(5, 2)
  carriedOver Decimal   @default(0) @db.Decimal(5, 2)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  employee    Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  leaveType   LeaveType @relation(fields: [leaveTypeId], references: [id])

  @@unique([employeeId, leaveTypeId, year])
}

model LeaveRequest {
  id               String      @id
  employeeId       String
  leaveTypeId      String
  startDate        DateTime
  endDate          DateTime
  days             Decimal     @db.Decimal(5, 2)
  reason           String?
  documentUrl      String?
  documentFileName String?
  status           LeaveStatus @default(PENDING)
  approverId       String?
  approvedAt       DateTime?
  rejectedAt       DateTime?
  rejectionReason  String?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime
  approver         Employee?   @relation("LeaveRequest_approverIdToEmployee", fields: [approverId], references: [id])
  employee         Employee    @relation("LeaveRequest_employeeIdToEmployee", fields: [employeeId], references: [id])
  leaveType        LeaveType   @relation(fields: [leaveTypeId], references: [id])
}

model LeaveType {
  id            String         @id
  name          String         @unique
  code          String         @unique
  description   String?
  defaultDays   Int
  carryOver     Boolean        @default(false)
  maxCarryOver  Int            @default(0)
  paid          Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  leaveBalances LeaveBalance[]
  leaveRequests LeaveRequest[]
}

model Payslip {
  id              String        @id
  employeeId      String
  payPeriodStart  DateTime
  payPeriodEnd    DateTime
  paymentDate     DateTime
  basicSalary     Decimal       @db.Decimal(12, 2)
  allowances      Decimal       @default(0) @db.Decimal(12, 2)
  overtime        Decimal       @default(0) @db.Decimal(12, 2)
  bonus           Decimal       @default(0) @db.Decimal(12, 2)
  grossSalary     Decimal       @db.Decimal(12, 2)
  cpfEmployee     Decimal       @default(0) @db.Decimal(12, 2)
  cpfEmployer     Decimal       @default(0) @db.Decimal(12, 2)
  incomeTax       Decimal       @default(0) @db.Decimal(12, 2)
  otherDeductions Decimal       @default(0) @db.Decimal(12, 2)
  totalDeductions Decimal       @db.Decimal(12, 2)
  netSalary       Decimal       @db.Decimal(12, 2)
  status          PayslipStatus @default(DRAFT)
  pdfUrl          String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  employee        Employee      @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, payPeriodStart, payPeriodEnd])
}

model SalaryInfo {
  id                String   @id
  employeeId        String   @unique
  basicSalary       Decimal  @db.Decimal(12, 2)
  allowances        Decimal  @default(0) @db.Decimal(12, 2)
  bankName          String?
  bankAccountNumber String?
  payNow            String?
  cpfApplicable     Boolean  @default(true)
  cpfEmployeeRate   Decimal  @default(20.00) @db.Decimal(5, 2)
  cpfEmployerRate   Decimal  @default(17.00) @db.Decimal(5, 2)
  effectiveDate     DateTime @default(now())
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  employee          Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id        String    @id
  email     String    @unique
  password  String
  role      Role      @default(STAFF)
  createdAt DateTime  @default(now())
  updatedAt DateTime
  accounts  Account[]
  employee  Employee?
  sessions  Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model CompanySettings {
  id        String   @id @default("company_settings")
  name      String   @default("Company Name")
  uen       String?
  address   String?
  phone     String?
  email     String?
  website   String?
  logo      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now())
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  TERMINATED
  RESIGNED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
}

enum EventType {
  HOLIDAY
  MEETING
  TRAINING
  COMPANY_EVENT
  LEAVE
}

enum ExpenseStatus {
  PENDING
  APPROVED
  REJECTED
  PAID
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum EducationLevel {
  DIPLOMA
  DEGREE
  MASTER
  PHD
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum PayslipStatus {
  DRAFT
  GENERATED
  PAID
}

enum Role {
  STAFF
  MANAGER
  HR
  ADMIN
}
